import os
import json
import argparse

def get_default_excludes():
    return [
        "_args",
        "_from",
        "_inCache",
        "_installable",
        "_nodeVersion",
        "_npmOperationalInternal",
        "_npmUser",
        "_npmVersion",
        "_phantomChildren",
        "_resolved",
        "_requested",
        "_requiredBy",
        "_where",
    ]

class Rewriter:
    def __init__(self, verbose, excludes):
        self.verbose = verbose
        self.excludes = excludes
        self._current_filename = ""
        if verbose > 1:
            print("rewriter excludes: %s" % self.excludes)
        if verbose > 2:
            print("rewriter excludes: %s" % self.excludes)
            self.union = {}

    def walk_path(self, path):
        for subdir, dirs, files in os.walk(path):
            for file in files:
                if "package.json" == file:
                    filepath = os.path.join(subdir, file)
                    self.process_package_json_file(filepath)

    def process_package_json_file(self, file):
        self._current_filename = file
        if self.verbose > 1:
            print "File: " + file
        json_obj = None
        with open(file, "r") as f:
            obj = json.load(f)
            if isinstance(obj, dict):
                json_obj = obj
                self.strip_excludes(json_obj)
        if json_obj:
            with open(file, "w") as f:
                json.dump(json_obj, f, sort_keys=True, indent=2)

    def strip_excludes(self, obj):
        """Remove all top-level json entries having a key in EXCLUDES.  The
           json argument will be modified in place."""
        if not isinstance(obj, dict):
            raise ValueError("json argument must be a dict")
        excludes = self.excludes

        for key in obj.keys():
            val = obj[key]
            if key in excludes:
                del obj[key]
                if self.verbose:
                    print "excluding: %s=%s from %s" % (key, val, self._current_filename)
            if hasattr(self, "union"):
                if key in vals:
                    self.union[key] += [val]
                else:
                    self.union[key] = [val]

        return obj

    def report(self):
        """Show output of the union of all top-level json objects."""
        if hasattr(self, "union"):
            for k, v in self.union.items():
                print k + ' ****************************************************************'
                print v


def main():
    parser = argparse.ArgumentParser(
        description='Rewrite package json files deterministically.')
    parser.add_argument("--path", nargs="+", default = [],
                        help='The root path to start file walk.')
    parser.add_argument("--exclude", nargs="+", default = [],
                        help='Key names to exclude from package json.')
    parser.add_argument("--verbose", action="count", default=0,
                        help='Print more debug messages.')
    args = parser.parse_args()
    excludes  = args.exclude or get_default_excludes()
    rewriter = Rewriter(args.verbose, excludes)
    for path in args.path:
        rewriter.walk_path(path)
    rewriter.report

if __name__ == '__main__':
  main()
